# هندسة النظام - SoaBra Glass Project Flow

## نظرة عامة

يعتمد نظام SoaBra على بنية تقنية حديثة تضمن الأداء العالي والتعاون الفوري مع مستوى أمان مؤسسي. النظام مصمم لتوفير تجربة مستخدم متقدمة في بيئة اللوحة البيضاء التعاونية.

## القرارات المعمارية

### الواجهة الأمامية (Frontend)
- **إطار العمل**: React 18 مع TypeScript (Strict Mode مُفعّل)
- **أداة البناء**: Vite لضمان سرعة التطوير والبناء
- **مولّد الواجهة**: Lovable بالكامل لضمان الاتساق والجودة
- **نظام التصميم**: Tailwind CSS مع semantic tokens مخصصة

### الرسم والتصور (Graphics & Rendering)
- **محرك الرسم**: WebGL باستخدام Pixi.js أو Regl
- **تحسين الأداء**: OffscreenCanvas مع Web Workers للعمليات المعقدة
- **هدف الأداء**: 60fps مع Re-render ≤ 16ms
- **إدارة المشهد**: Scene Graph مع Quadtree للفهرسة المكانية

### التعاون الفوري (Real-time Collaboration)
- **محرك CRDT**: Yjs لضمان التزامن بدون تضارب
- **مقدم الخدمة**: YSupabaseProvider مخصص
- **الشبكة**: Supabase Realtime حصرياً
- **القنوات**: `board:{id}` لكل لوحة منفصلة

### الخدمات الخلفية (Backend Services)
جميع الخدمات الخلفية تعتمد على **Supabase بالكامل**:

#### المصادقة والترخيص
- **النظام**: Supabase Auth مع Row Level Security (RLS)
- **الأذونات**: مبنية على user_id مع policies صارمة
- **الجلسات**: JWT tokens مُدارة بالكامل عبر Supabase

#### قاعدة البيانات
- **النوع**: PostgreSQL عبر Supabase
- **البنية**: جداول محسّنة مع فهارس متقدمة
- **الأمان**: RLS policies على كل جدول
- **الأداء**: Views محسّنة للاستعلامات المعقدة

#### التخزين
- **الخدمة**: Supabase Storage
- **الحاوية**: `board-assets` للملفات والصور
- **الأمان**: RLS policies للوصول المحدود

#### الوظائف السحابية
- **البيئة**: Deno runtime عبر Supabase Edge Functions
- **الاستخدام**: نقاط الذكاء الصناعي فقط
- **الوظائف الأساسية**:
  - `analyze-links`: تحليل الروابط بالذكاء الصناعي
  - `wf01-map`: تخطيط سير العمل

### الذكاء الصناعي
- **التكامل**: داخل Edge Functions فقط لضمان الأمان
- **النماذج**: OpenAI أو نماذج مفتوحة المصدر حسب الحاجة
- **الخصوصية**: لا تسرّب للمفاتيح أو البيانات الحساسة

## مقاييس الأداء

### أهداف الأداء الإجبارية
- **معدل الإطارات**: 60fps ثابت
- **وقت التفاعل**: TTI ≤ 2.5s
- **إعادة الرسم**: Re-render ≤ 16ms
- **التأخير الشبكي**: Realtime ≤ 150ms داخل المنطقة

### آليات التحسين
- **Virtual Rendering**: لمعالجة مجموعات البيانات الضخمة
- **Memory Pool**: لإعادة استخدام كائنات Canvas
- **Intersection Observer**: لتحديد العناصر المرئية
- **Debounced Updates**: لتقليل العمليات غير الضرورية

## الدعم متعدد الاتجاهات

### RTL/LTR
- **مقدم السياق**: DirectionProvider للتحكم العام
- **خصائص CSS**: Logical Properties بدلاً من المادية
- **اختبار**: تغطية شاملة للتخطيطات ثنائية الاتجاه

## ضمان الجودة (Quality Gates)

### أدوات الجودة
- **ESLint**: قواعد TypeScript صارمة
- **Prettier**: تنسيق موحد للكود
- **Husky**: Git hooks للفحص قبل الـ commit
- **lint-staged**: فحص الملفات المُعدّلة فقط

### الاختبارات
- **الوحدة**: Vitest مع تغطية ≥ 80%
- **التكامل**: Playwright للاختبارات الحيوية
- **الأداء**: اختبارات آلية في CI
- **الإمكانية**: اختبارات a11y شاملة

### التكامل المستمر
- **المنصة**: GitHub Actions
- **المراحل**: lint → test → build → deploy
- **البوابات**: جميع الاختبارات يجب أن تنجح
- **البيئات**: staging أولاً ثم production

## البنية الملفية

```
src/
├── apps/brain/              # التطبيق الرئيسي
│   ├── canvas/              # مكونات اللوحة
│   ├── plugins/             # إضافات العناصر الذكية
│   └── workflows/           # سير العمل WF-01
├── components/Whiteboard/   # المكونات الأساسية
├── lib/supabase/           # أدوات Supabase
├── workers/                # Web Workers للأداء
└── docs/                  # التوثيق

supabase/
├── functions/             # Edge Functions
├── migrations/           # هجرة قاعدة البيانات
└── config.toml          # تكوين Supabase
```

## الأمان والامتثال

### مبادئ الأمان
- **Zero Trust**: لا ثقة ضمنية، كل طلب مُصادق
- **Principle of Least Privilege**: أقل الصلاحيات المطلوبة
- **Defense in Depth**: طبقات أمان متعددة

### حماية البيانات
- **التشفير**: في النقل والتخزين
- **RLS**: على مستوى قاعدة البيانات
- **التدقيق**: سجل شامل لكل العمليات

## خطة التطوير

### المرحلة 1: الأساسيات
- [x] إعداد Quality Gates
- [x] TypeScript Strict Mode
- [x] تكوين أدوات الجودة

### المرحلة 2: البنية الأساسية
- [ ] إعداد Supabase Backend
- [ ] تنفيذ Canvas الأساسي
- [ ] نظام المصادقة

### المرحلة 3: الميزات المتقدمة
- [ ] التعاون الفوري مع Yjs
- [ ] تكامل الذكاء الصناعي
- [ ] تحسينات الأداء

### المرحلة 4: التسليم
- [ ] الاختبارات الشاملة
- [ ] التوثيق النهائي
- [ ] النشر الإنتاجي

## الخلاصة

تضمن هذه البنية تجربة مستخدم متقدمة مع أداء عالي وأمان مؤسسي. جميع التقنيات المختارة تدعم الهدف النهائي لإنشاء منصة تعاونية قوية وموثوقة.