# WhiteBoard Context

## تعريف الدور الوظيفي

**منسق التخطيط التشاركي** هو المسؤول عن ضمان أن بيئة العمل الرقمية (*SoaBra‑TheBrain*) تجمع بين فرق العمل والبيانات وخطوات التخطيط في واجهة واحدة ديناميكية تُمكّن من التفاعل اللحظي والتحليل المدمج. يتحكّم المنسق في تشغيل اللوحة وإدارة الصلاحيات والتوثيق الآلي للتغييرات لضمان التتبع والمراجعة الدائمة.

## البروتوكول التشغيلي

### تهيئة البيئة

1. **استيراد المستودع**:
   ```bash
   git clone https://github.com/soa-bra/glass-project-flow.git
   cd glass-project-flow
   ```
2. **تثبيت الاعتمادات**: نفّذ `npm install` لتثبيت الحزم المحددة في `package.json`.
3. **تشغيل الخادم**: استخدم `npm run dev` لتشغيل الخادم المحلي ومتابعة التطوير.

### بنية اللوحة

تتكون اللوحة من الوحدات الرئيسية التالية:

| الوحدة | الوصف |
| --- | --- |
| **تجميع المدخلات** | تستقبل الأهداف والمهام والموارد من جميع الفرق وتوحّدها في صيغة موحّدة. |
| **المزامنة الفورية** | تستخدم WebSocket أو GraphQL Subscriptions لضمان تحديث جميع العملاء آنياً. |
| **العرض التحليلي** | توفر مخططات Gantt وKanban وجداول ديناميكية لعرض التقدّم والموارد. |
| **التوثيق الآلي** | تحفظ نسخة زمنية لكل تعديل وتضمن إمكانية التراجع (Undo/Redo) والمراجعة. |

### تدفق العمل القياسي

1. **إدخال الهدف**: يضيف المستخدم الهدف العام للمشروع أو المهمة.
2. **تفكيك المهام**: يقسم الهدف إلى مهام فرعية قابلة للإسناد.
3. **ربط الموارد**: يحدد الفريق أو الفرد المسؤول عن كل مهمة والموارد اللازمة.
4. **إسناد المواعيد النهائية**: يحدد المواعيد الزمنية لإنجاز كل مهمة.
5. **متابعة التقدم**: تُعرض حالة كل مهمة في اللوحة ويُسجّل كل تعديل في سجل القرارات.

### طبقة الصلاحيات (RBAC)

- تعتمد اللوحة على نموذج صلاحيات قائم على الدور حيث يحدد لكل مستخدم ما إذا كان يستطيع الإضافة أو التعديل أو الموافقة. 
- يجب تمرير جميع التعديلات عبر مرحلة مراجعة حتى لا يحدث تضارب في النسخ أو تعديل غير مصرح به.

### تكامل البيانات

- تربط اللوحة مع الوحدات الأخرى للنظام (المحاسبة، الموارد البشرية، التقارير) عبر API داخلي موحّد. 
- يمنع إجراء أي تعديل على البيانات خارج مسار المراجعة الرسمي.

## القيود الصارمة لضمان الجودة

1. يمنع إدخال أي مكون بصري أو تحليلي لا يتكامل مع المزامنة اللحظية. 
2. يمنع الاعتماد على تحديث يدوي للمعطيات؛ كل شيء يجب أن يكون متزامناً تلقائياً. 
3. يمنع ازدواجية تعريف المهام أو تضارب النسخ. 
4. جميع التغييرات يجب أن تُسجّل وتكون قابلة للتتبع عبر خاصية التاريخ (Undo/Redo). 
5. يحظر تعديل البيانات خارج مسار المراجعة الرسمية في اللوحة.

## مكونات لوحة التخطيط التشاركي

هذا المشروع يحتوي على مكون React يدعى `Whiteboard`، يمثل لوحة تخطيط تشاركي قابلة للتوسّع. أهم خصائصه:

- **كانفس لا نهائية** مع إمكانية السحب والتكبير/التصغير، وشبكة اختيارية. 
- **شريط أدوات علوي** يوفر أزرار Undo/Redo، تفعيل الشبكة، تبديل الوضع الليلي/النهاري، وفتح اللوحات الجانبية. 
- **شريط أدوات سفلي** يعرض مستوى التكبير وقائمة المشاركين. 
- **لوحات جانبية** تشمل المساعد الذكي (محادثة تربط مع ‎`/ai/assist`)، طبقات العمل، المظهر، والتعاون. 
- **إدارة الحالة** باستخدام Zustand لضبط الإزاحات، التكبير، الشبكة، المظهر، المحادثة، والمشاركين. 
- **تكامل Liveblocks** لإظهار المشاركين في الوقت الحقيقي (يتطلب مفتاح `VITE_LIVEBLOCKS_PUBLIC_KEY`). 
- **توثيق آلي** للحركات الرئيسية (Pan/Zoom/Grid) مع إمكانية التراجع/الإعادة عبر Ctrl+Z وCtrl+Shift+Z.

## خطوات تركيب اللوحة في المشروع

1. **فك الضغط**: استخرج محتويات ملف `collaborative-planning-whiteboard-updated.zip` وضع مجلد `src/components/Whiteboard` داخل مجلد المشروع `glass-project-flow-main` (أو قم باستبدال المجلد الموجود إن وجد). 
2. **استيراد المكون**: داخل ملف الصفحة الرئيسية للتخطيط أو `PlanningWorkspace` استورد المكون واستخدمه:

   ```tsx
   import Whiteboard from '@/components/Whiteboard';

   export default function PlanningWorkspace() {
     return <Whiteboard />;
   }
   ```

3. **تثبيت الحزم**: تأكد من وجود الحزم `zustand`, `lucide-react`, `@liveblocks/client`, و`@liveblocks/react` في `package.json` ثم نفّذ `npm install`. 
4. **ملف البيئة**: أنشئ ملف `.env.local` في الجذر يحتوي على مفتاح Liveblocks:

   ```env
   VITE_LIVEBLOCKS_PUBLIC_KEY=pk_live_********
   ```
5. **تشغيل الخادم**: نفّذ `npm run dev` للتحقق من عمل اللوحة ثم تكاملها مع بقية النظام.

بإتباع هذه الخطوات تصبح لوحة التخطيط التشاركي جزءاً متكاملاً من نظام سوبرا المتكامل، مع الالتزام بجميع متطلبات التتبع والمزامنة الفورية والحوكمة.